- name: Install Grafana operator # noqa role-name[path]
  ansible.builtin.include_role:
    name: "{{ playbook_dir }}/openshift-edge-installer/common/roles/install_operator"
  vars:
    operator_name: grafana-operator
    operator_namespace: grafana
    all_namespaces: false
    cluster_monitoring: false
    catalog_source: community-operators

- name: Create Grafana data source
  kubernetes.core.k8s:
    definition:
      apiVersion: integreatly.org/v1alpha1
      kind: GrafanaDataSource
      metadata:
        name: grafana-loki
        namespace: grafana
      spec:
        name: loki.yaml
        datasources:
          - name: Loki
            type: loki
            access: proxy
            url: http://logging-loki-gateway-http.openshift-logging.svc:8080
    apply: true
    state: present
  register: k8s_result
  until: k8s_result is not failed

- name: Create Grafana
  kubernetes.core.k8s:
    definition:
      apiVersion: integreatly.org/v1alpha1
      kind: Grafana
      metadata:
        name: grafana
        namespace: grafana
      spec:
        baseImage: docker.io/grafana/grafana:9.3.2
        ingress:
          enabled: true
        config:
          auth.anonymous:
            enabled: false
    apply: true
    state: present
  register: k8s_result
  until: k8s_result is not failed
